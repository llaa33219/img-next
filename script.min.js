// script.min.js

const fileSelectButton = document.getElementById('fileSelectButton');
const fileInput = document.getElementById('fileInput');
const fileNameDisplay = document.getElementById('fileNameDisplay');
const uploadButton = document.getElementById('uploadButton');
const statusElem = document.getElementById('status');
const linkBox = document.getElementById('linkBox');
const copyButton = document.getElementById('copyButton');
const customNameInput = document.getElementById('customNameInput');
const defaultNameRadio = document.getElementById('defaultName');
const customNameRadio = document.getElementById('customName');

// 이름 옵션 라디오 버튼 처리 - 수정
document.getElementById('defaultName').addEventListener('change', function() {
  if(this.checked) {
    customNameInput.classList.remove('active');
  }
});

document.getElementById('customName').addEventListener('change', function() {
  if(this.checked) {
    customNameInput.classList.add('active');
    customNameInput.focus();
  }
});

// 페이지 로드 시 초기화 추가
window.addEventListener('DOMContentLoaded', function() {
  // 기본 이름 라디오 버튼이 선택되었는지 확인
  if(defaultNameRadio.checked) {
    customNameInput.classList.remove('active');
  } else if(customNameRadio.checked) {
    customNameInput.classList.add('active');
  }
});

// 사용자 지정 이름 입력 처리 - 모든 문자 허용
customNameInput.addEventListener('input', () => {
  // 특수 문자 제한 없음, 모든 언어 허용
});

// 파일 선택 시 파일명 업데이트
fileSelectButton.addEventListener('click', () => {
  fileInput.click();
});

fileInput.addEventListener('change', () => {
  if (fileInput.files.length > 0) {
    const names = Array.from(fileInput.files).map(f => f.name);
    fileNameDisplay.textContent = names.join(', ');
    
    // 사용자 지정 이름 자동 제안하지 않음
  } else {
    fileNameDisplay.textContent = '파일 선택 안됨';
  }
});

// 업로드 버튼 클릭 이벤트 (다중 파일 처리 + 커스텀 이름 옵션)
uploadButton.addEventListener('click', async () => {
  if (fileInput.files.length === 0) {
    statusElem.textContent = '파일이 선택되지 않았습니다.';
    return;
  }
  
  // 사용자 지정 이름 옵션 확인
  const isCustomName = customNameRadio.checked;
  if (isCustomName && !customNameInput.value.trim()) {
    statusElem.textContent = '사용자 지정 이름을 입력해주세요.';
    customNameInput.focus();
    return;
  }
  
  // 검열 단계 진행 중 메시지 표시
  statusElem.textContent = '검열 중...';
  const formData = new FormData();
  for (const file of fileInput.files) {
    formData.append('file', file);
  }
  
  // 사용자 지정 이름 추가
  if (isCustomName) {
    formData.append('customName', customNameInput.value.trim());
  }
  
  // 일정 시간 후 검열이 완료되지 않으면 업로드 중 메시지로 변경
  const timer = setTimeout(() => {
    statusElem.textContent = '업로드 중...';
  }, 2000);
  try {
    const response = await fetch('/upload', {
      method: 'POST',
      body: formData
    });
    clearTimeout(timer);
    const result = await response.json();
    if (result.success) {
      linkBox.value = result.url;
      statusElem.textContent = '업로드 성공';
    } else {
      statusElem.textContent = '업로드 실패: ' + (result.error || '알 수 없는 에러');
    }
  } catch (err) {
    clearTimeout(timer);
    statusElem.textContent = '업로드 중 오류 발생: ' + err.message;
  }
});

// 복사 버튼 클릭 이벤트
copyButton.addEventListener('click', async () => {
  if (linkBox.value) {
    try {
      await navigator.clipboard.writeText(linkBox.value);
      statusElem.textContent = '링크가 복사되었습니다.';
    } catch (err) {
      statusElem.textContent = '복사 실패: ' + err.message;
    }
  }
});

// 클립보드에서 이미지 붙여넣기 이벤트 추가
document.addEventListener('paste', (event) => {
  const clipboardItems = event.clipboardData.items;
  let hasImage = false;
  // 기존 파일과 함께 붙여넣은 이미지 파일들을 추가하기 위해 DataTransfer 객체 사용
  const dt = new DataTransfer();
  // 기존 fileInput에 선택된 파일들을 추가
  for (const file of fileInput.files) {
    dt.items.add(file);
  }
  // 클립보드 아이템 순회
  for (let i = 0; i < clipboardItems.length; i++) {
    const item = clipboardItems[i];
    if (item.type && item.type.startsWith('image/')) {
      const file = item.getAsFile();
      if (file) {
        dt.items.add(file);
        hasImage = true;
      }
    }
  }
  if (hasImage) {
    fileInput.files = dt.files;
    const names = Array.from(fileInput.files).map(f => f.name);
    fileNameDisplay.textContent = names.join(', ');
    statusElem.textContent = '클립보드에서 이미지 추가됨.';
  }
});